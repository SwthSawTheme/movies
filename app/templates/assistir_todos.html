<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <title>Assistindo: {{ colecao.nome }}</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
  <style>
    /* remove a borda quando entrar em tela cheia */
    video:fullscreen { 
      border: none !important; 
      border-radius: 0 !important;
      outline: none !important;
    }
    video:-webkit-full-screen { 
      border: none !important; 
      border-radius: 0 !important;
      outline: none !important;
    }
    video:-moz-full-screen { 
      border: none !important; 
      border-radius: 0 !important;
      outline: none !important;
    }
    video:-ms-fullscreen { 
      border: none !important; 
      border-radius: 0 !important;
      outline: none !important;
    }
    video {
      width: 100%;
      max-width: 960px;
      display: block;
      margin: 2rem auto;
      border: 4px solid #e50914;
      border-radius: 10px;
      background: #000;
    }
    .titulo {
      text-align: center;
      color: #e50914;
      font-size: 2rem;
      margin-top: 1.5rem;
    }
    .toolbar {
      display: flex;
      gap: 12px;
      justify-content: center;
      margin: 12px 0 20px;
      flex-wrap: wrap;
    }

    /* botões no mesmo padrão do site */
    .btn {
      display: inline-block;
      padding: 10px 18px;
      border-radius: 8px;
      text-decoration: none;
      border: none;
      cursor: pointer;
      transition: filter .2s ease;
      font-weight: 600;
      min-width: 190px;
      text-align: center;
    }
    .btn-primary {
      background: #e50914;
      color: #fff;
    }
    .btn-outline {
      background: transparent;
      color: #e50914;
      border: 2px solid #e50914;
    }
    .btn:hover { filter: brightness(1.08); }
    .btn[disabled] { opacity: .55; pointer-events: none; }
  </style>
</head>
<body>
  <h1 class="titulo">▶ Assistindo: {{ colecao.nome }}</h1>
  <h2 class="titulo" id="tituloFilmeAtual" style="font-size:1.4rem;"></h2>

  <div class="toolbar">
    <a class="btn btn-outline" href="{{ url_for('routes.ver_colecao', colecao_id=colecao.id) }}">← Voltar à Coleção</a>
    <button class="btn btn-primary" id="btnPrev" type="button">◀ Anterior Filme</button>
    <button class="btn btn-primary" id="btnNext" type="button">Próximo Filme ▶</button>
  </div>

  <video id="player" controls autoplay></video>

  <script>
    const filmes = {{ filmes | tojson }};
    let indexAtual = {{ indice_atual|default(0, true) }};
    const player   = document.getElementById('player');
    const tituloEl = document.getElementById('tituloFilmeAtual');
    const btnNext  = document.getElementById('btnNext');
    const btnPrev  = document.getElementById('btnPrev');

    function carregarFilme(index) {
      const filme = filmes[index];
      if (!filme) return;

      player.src = `/media/video/${filme.id}`;
      tituloEl.textContent = filme.titulo;
      player.load();
      player.play().catch(()=>{}); // caso autoplay seja bloqueado
      atualizarBotoes();
      // mantém o índice na URL
      const url = new URL(window.location.href);
      url.searchParams.set('indice', index);
      window.history.replaceState({}, '', url);
    }

    function irProximo() {
      if (indexAtual + 1 < filmes.length) {
        indexAtual++;
        carregarFilme(indexAtual);
      }
    }

    function irAnterior() {
      if (indexAtual > 0) {
        indexAtual--;
        carregarFilme(indexAtual);
      }
    }

    function atualizarBotoes() {
      // prev
      if (indexAtual > 0) {
        btnPrev.disabled = false;
      } else {
        btnPrev.disabled = true;
      }
      // next
      if (indexAtual + 1 < filmes.length) {
        btnNext.disabled = false;
        btnNext.textContent = 'Próximo Filme ▶';
      } else {
        btnNext.disabled = true;
        btnNext.textContent = 'Último filme';
      }
    }

    // cliques
    btnNext.addEventListener('click', (e) => { e.preventDefault(); irProximo(); });
    btnPrev.addEventListener('click', (e) => { e.preventDefault(); irAnterior(); });

    // terminou: vai pro próximo; se acabou, volta pra coleção
    player.addEventListener('ended', () => {
      if (indexAtual + 1 < filmes.length) {
        irProximo();
      } else {
        window.location.href = "{{ url_for('routes.ver_colecao', colecao_id=colecao.id) }}";
      }
    });

    // atalhos: N = próximo, P = anterior, setas → e ← também
    document.addEventListener('keydown', (ev) => {
      const k = ev.key.toLowerCase();
      if (k === 'n' || ev.key === 'ArrowRight') irProximo();
      if (k === 'p' || ev.key === 'ArrowLeft')  irAnterior();
    });

    // start
    carregarFilme(indexAtual);
  </script>
</body>
</html>
